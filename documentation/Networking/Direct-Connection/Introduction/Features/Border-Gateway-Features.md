## **边界网关**

### **基本概念**

边界网关(BGW，Border Gateway)，是京东云用来承载VPC南北向流量的一种网关，主要作用是与其他外部网关或环境进行内网互通。

在边界网关支持创建VPC接口功能前，边界网关一旦创建、即自动与同地域的所有VPC连通。

随着边界网关的VPC接口功能上线，新建的边界网关默认不与任何VPC连通，用户需要创建"VPC接口”用于打通指定VPC和边界网关的互联；对于已经创建的边界网关，边界网关路由表内已有到VPC的路由仍然有效可用，但是不能新建到VPC的路由、除非先创建出与VPC关联的VPC接口。

目前边界网关承载的业务是专线服务、托管服务、VPN服务、VPC连接功能。

边界网关支持客户IDC和京东云VPC之间通信、京东云托管区和京东云VPC之间通信、京东云同地域多个VPC之间通信。

通常情况下，连接到同一边界网关的专线通道/托管通道之间无法通过边界网关进行通信。

通过边界网关可访问的京东云资源：京东云VPC内的全部资源，包括云主机、容器、负载均衡、云数据库、云缓存等，但是不能利用VPC内NAT网关统一互联网出口。

 ### **边界网关路由管理**
 
 #### **边界网关路由类型**
 
  边界网关作为京东云多个隔离网络（VPC）之间、或者从京东云云端与用户IDC互联的路由网关，提供了静态与BGP动态路由能力，同时为了简化用户业务部署而支持了VPC与网关之间路由的双向传播能力、以便完整支持从VPC到IDC端到端的路由自动更新。

##### **静态路由**

  边界网关支持通过手动配置管理路由规则，包括新建、修改、删除静态路由规则。路由规则中下一跳类型当前支持VPC接口、专线通道、VPN通道、托管通道等。

##### **路由传播**

  路由传播是通过手动配置方式之外获取的路由规则，例如通过标准BGP协议等动态路由方式学习到的路由，或者通过内部工作机制将不同网关实体（如VPC路由表所在的路由网关、边界网关）的路由表项信息进行同步、自动更新到达或者经由彼此转发业务的路由信息。

- VPC路由表和边界网关路由表之间可通过VPC接口实现双向路由动态传播：

  边界网关->VPC方向的路由传播：当从VPC路由表配置路由传播时，选择路由传播的源边界网关与填写路由传播范围。传播关系建立后，系统将自动把该边界网关有效路由表中、路由前缀在传播范围内的特定路由规则自动添加VPC路由表内，并且下一跳指向与该VPC创建传播关系的边界网关；
  
  VPC->边界网关方向的路由传播：当基于BGW创建VPC接口时，如果传播VPC网段选择“VPC全部网段”或者“指定子网网段”时，即为路由自动传播方式。边界网关路由表会依据配置的子网范围，自动添加或者删除到达相关子网的路由表项，路由前缀为子网网段、下一跳为连接指定VPC和边界网关的VPC接口。

- 边界网关与用户IDC网关通过BGP协议学习到的路由，路由类型目前在边界网关路由表中也定义为传播路由。包括：

   通过专线通道连通的边界网关与用户IDC网关通过BGP协议学习到的路由；
 
   通过托管通道连通的边界网关与用户IDC网关通过BGP协议学习到的路由；
 
   通过VPN通道连通的边界网关与用户IDC网关通过BGP协议学习到的路由。
 
#### **边界网关路由排序规则**

 ***路由表分类***
 
 边界网关的动态路由表内包括所有学习到的传播路由，但由于获取传播路由的途径不一样，需要将掩码长度和前缀一样的路由规则进行比对、筛选出最高优先级的路由规则添加到边界网关的有效路由表中。
 
  边界网关传播路由中相同掩码长度的相同前缀进行比对时、遵循一定的优先级和规则，优先级按照不同传播源优先级值从小到大逐渐降低，即优先级数值越小、路由优先级别越高。其中VPC传播路由优先级缺省为110、EBGP传播路由优先级缺省为120，IBGP传播路由优先级缺省为200。

   ***传播路由内部排序***

   VPC传播路由优先级最高，前缀与掩码长度相同的有效路由仅一条、先加入者生效，先加入路由表的vpc传播路由删除后、后续的vpc传播路由再生效；

   EBGP动态路由优先级其次，如果同为EBGP路由，按照如下顺序从上到下优选：
  
     -AS_PATH最短的路由优选；
  
     -如果AS_PATH相同，最小MED路由优选；

     -如果AS_PATH和MED都相同，则视为等价路由。

  IBGP动态路由优先级最低。

#### **边界网关有效路由表**
  
 ***边界网关有效路由表优选规则***
 
   京东云边界网关的有效路由表包括两种路由类型：静态路由和传播路由。路由优先级值范围为1~256，其中静态路由优先级缺省为100、传播路由继承不同传播源的路由优先级——VPC传播路由优先级缺省为110、EBGP传播路由优先级缺省为120，IBGP传播路由优先级缺省为200。
   
   有效路由表依据路由优先级值进行有效路由甄选：前缀与掩码长度不重叠的路由规则（来自于静态路由或者传播路由）直接加入有效路由表；前缀与掩码长度重叠的路由规则、则选择路由规则优先级值最小的路由规则加入有效路由表，如果路由规则优先级值一样则为等价路由。
   
   边界网关有效路由表中仅展示经过比对优选出的实际有效路由规则，一些掩码长度和前缀相同的低优先级无效路由不会在有效路由表中展示、但可以在动态路由表中可以查询。

  
  ***边界网关有效路由规则匹配顺序***
   
   边界网关进行业务数据转发时，将依据其有效路由表内的路由规则进行逐项匹配、然后按照路由规则的下一跳信息将报文转发到相应的接口或者通道。其基本路由匹配和转发规则为：
   
   最长掩码长度的路由匹配优先；

   等价路由则基于每个数据报文轮转选择不同下一跳进行转发。
   
