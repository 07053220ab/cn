## **边界网关**

### **基本概念**

边界网关(BGW，Border Gateway)，是京东云用来承载VPC南北向流量的一种网关，主要作用是与其他外部网关或环境进行内网互通。

在边界网关支持创建VPC接口功能前，边界网关一旦创建、即自动与同地域的所有VPC连通。

随着边界网关的VPC接口功能上线，新建的边界网关默认不与任何VPC连通，用户需要创建"VPC接口”用于打通指定VPC和边界网关的互联；对于已经创建的边界网关，边界网关路由表内已有到VPC的路由仍然有效可用，但是不能新建到VPC的路由、除非先创建出与VPC关联的VPC接口。

目前边界网关承载的业务是专线服务、托管服务、VPN服务、VPC连接功能。

边界网关支持客户IDC和京东云VPC之间通信、京东云托管区和京东云VPC之间通信、京东云同地域多个VPC之间通信。

通常情况下，连接到同一边界网关的专线通道/托管通道之间无法通过边界网关进行通信。

通过边界网关可访问的京东云资源：京东云VPC内的全部资源，包括云主机、容器、负载均衡、云数据库、云缓存等，但是不能利用VPC内NAT网关统一互联网出口。

 ### **边界网关路由管理**
 
#### 路由表分类

京东云内开放给用户配置路由功能的网关/路由器均具备如下几张路由表：
* `有效路由表`，存放实际生效路由的路由表(路由表中可能包括由系统自动生成的Local路由)，数据包转发时按此表中的路由条目进行转发，不支持编辑；
* `静态路由表`，存放用户手工添加的静态路由(Static Route)，支持编辑；
* `传播路由表`，目前存放两种来源的路由：一种是用户配置从其他网关等资源自动传播来的路由(如创建VPC接口时，将VPC网段路由添加到边界网关的传播路由表)，不支持直接编辑，可通过修改相应资源的传播配置进行传播路由变更；另一种是通过动态路由协议BGP学习到的路由，BGP路由不支持在路由表中直接编辑，可通过在路由来源侧(BGP Peer侧)编辑后同步/收敛到BGP路由表；

#### 有效路由规则匹配顺序
   
   边界网关进行业务数据转发时，将依据其有效路由表内的路由规则进行逐项匹配、然后按照路由规则的下一跳信息将报文转发到相应的接口或者通道。其基本路由匹配和转发规则为：
   
   最长掩码长度的路由匹配优先；

   等价路由则基于每个数据报文的三元组（源目的IP+协议类型）进行hash选择不同下一跳进行转发。
   

#### 有效路由表的路由来源

* 根据静态路由表、传播路由表中的路由及其优先级，`优选生效的路由条目，并存放到有效路由表中，实际的出流量按此路由表中的路由条目进行转发。数据包转发时的路由匹配规则为：最长前缀匹配(Longest prefix match)`。
* 路由条目优选原则为：目的地(Destination)不同的路由直接存放，目的地相同的路由根据下一跳类型、路由类型、Metric计算出优先级最高的路由条目并存放到有效路由表中。目的地相同的路由的优先级计算方式详见下方的“路由优先级计算因素”和“路由优先级计算规则”。


<br />

#### 路由优先级计算因素
路由优先级的计算分为几个不同的维度，综合计算所有维度后，得出该条路由的最终优先级，涉及的计算维度包括：
* 下一跳类型，包括VPN连接(VPN Connection)、专线通道(Private Virtual Interface)、托管通道(Private Virtual Interface)等，每种下一跳类型对应的优先级详见下方表格，下一跳类型数值越小，优先级越高；
* 路由类型(管理距离，Administrative Distance)，包括静态路由(Static)、BGP路由(BGP)，取值范围：0~255，管理距离数值越小，优先级越高；
* 路由Metric，为路由指定所需跃点数的整数值(取值范围是：0~4,294,967,295 (32-bit Integer)，EIGRP的取值范围，是否需要这么大待定)，它用来在路由表里的多个路由中选择与转发包中的目标地址最为匹配的路由。所选的路由具有最少的跃点数。跃点数能够反映跃点的数量、路径的速度、路径可靠性、路径吞吐量以及管理属性等，对多种属性经过计算后生成。Metric数值越小，优先级越高；

<br />

#### 路由优先级计算规则
* 第一步，优选下一跳类型优先级最高的路由，若可以确定唯一的路由条目，则返回该路由。若存在多条优先级相同的路由，则继续下一因素的比较；
* 第二步，优选路由类型优先级最高的路由，若可以确定唯一的路由条目，则返回该路由。若存在多条优先级相同的路由，则继续下一因素的比较；
* 第三步，优选Metric优先级最高的路由，若可以确定唯一的路由条目，则返回该路由。若存在多条优先级相同的路由，则多条路由均为有效路由，多条路由之间以ECMP的方式转发数据包；

<br />

##### 各种下一跳类型的优先级说明(边界网关)

|                下一跳网关名称                | 应用的路由表 | 下一跳类型优先级 |                       备注                        |
|:--------------------------------------------:|:------------:|:----------------:|:-------------------------------------------------:|
|         VPC Attachment/VPC(专线通道)         |  BGW路由表   |       100        |                                               |
|         BGW Peering         |  BGW路由表   |       110        |                      预留                         |
| Private Virtual Interface(专线通道/托管通道) |  BGW路由表   |       120        | 目前无法区分专线通道/托管通道，预留后续拆分的能力 |
|           VPN Connection(VPN连接)            |  BGW路由表   |       140        |                                                   |

优先级制定原则，优先级依次降级：
* 去往VPC内资源的路由，如VPC Attachment；
* 去往VPC外资源的路由，如专线通道、托管通道、VPN，~~当同时存在专线通道和托管通道时，专线通道优先~~；

<br />

##### 各种路由类型的优先级说明(Administrative Distance，路由协议的管理距离，适用于所有路由表)

| 路由类型 | 路由协议优先级 | 备注 |
|:--------------:|:--------------:|:----:|
|      静态      |      100    |      |
|      传播      |      120       |      |
|      EBGP      |      150       |      |
|      IBGP      |      200       |  暂未使用    |

<br />




#### **边界网关路由排序规则**

 ***路由表分类***
 
 边界网关的动态路由表内包括所有学习到的传播路由，但由于获取传播路由的途径不一样，需要将掩码长度和前缀一样的路由规则进行比对、筛选出最高优先级的路由规则添加到边界网关的有效路由表中。
 
  边界网关传播路由中相同掩码长度的相同前缀进行比对时、遵循一定的优先级和规则，优先级按照不同传播源优先级值从小到大逐渐降低，即优先级数值越小、路由优先级别越高。其中VPC传播路由优先级缺省为110、EBGP传播路由优先级缺省为120，IBGP传播路由优先级缺省为200。

   ***传播路由内部排序***

   VPC传播路由优先级最高，前缀与掩码长度相同的有效路由仅一条、先加入者生效，先加入路由表的vpc传播路由删除后、后续的vpc传播路由再生效；

   EBGP动态路由优先级其次，如果同为EBGP路由，按照如下顺序从上到下优选：
  
     -AS_PATH最短的路由优选；
  
     -如果AS_PATH相同，最小MED路由优选；

     -如果AS_PATH和MED都相同，则视为等价路由。

  IBGP动态路由优先级最低。

#### **边界网关有效路由表**
  
 ***边界网关有效路由表优选规则***
 
   京东云边界网关的有效路由表包括两种路由类型：静态路由和传播路由。路由优先级值范围为1~256，其中静态路由优先级缺省为100、传播路由继承不同传播源的路由优先级——VPC传播路由优先级缺省为110、EBGP传播路由优先级缺省为120，IBGP传播路由优先级缺省为200。
   
   有效路由表依据路由优先级值进行有效路由甄选：前缀与掩码长度不重叠的路由规则（来自于静态路由或者传播路由）直接加入有效路由表；前缀与掩码长度重叠的路由规则、则选择路由规则优先级值最小的路由规则加入有效路由表，如果路由规则优先级值一样则为等价路由。
   
   边界网关有效路由表中仅展示经过比对优选出的实际有效路由规则，一些掩码长度和前缀相同的低优先级无效路由不会在有效路由表中展示、但可以在动态路由表中可以查询。

  
  ***边界网关有效路由规则匹配顺序***
   
   边界网关进行业务数据转发时，将依据其有效路由表内的路由规则进行逐项匹配、然后按照路由规则的下一跳信息将报文转发到相应的接口或者通道。其基本路由匹配和转发规则为：
   
   最长掩码长度的路由匹配优先；

   等价路由则基于每个数据报文轮转选择不同下一跳进行转发。
   
